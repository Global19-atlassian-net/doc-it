<?xml version="1.0" encoding="utf-8"?>
<!-- EN-Revision: 2bb07c8c43f028c665a33bfc08a22639e9e35dc6 Maintainer: cucinato Status: ready -->
 <chapter xml:id="features.safe-mode" xmlns="http://docbook.org/ns/docbook">
  <title>Modalità sicura (Safe mode)</title>

  <para>
   La modalità Safe Mode è un tentativo di risolvere il problema di sicurezza 
   derivante dalla condivisione del server. Dal punto di vista architetturale
   non è corretto cercare di risolvere questo problema al livello del PHP, ma
   poiché le alternative al livello del web server e del SO (Sistema Operativo)
   non sono realistiche, in molti, specialmente ISP (Internet Service Provider), utilizzano la modalità sicura. 
  </para>
  
  &warn.deprecated.feature-5-3-0.removed-5-4-0;

  <para>
   <table>
    <title>Cronologia di <literal>safe mode</literal></title>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>&Version;</entry>
       <entry>&Description;</entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>5.4.0</entry>
       <entry>
        Rimosso da PHP, agenera un errore di livello fatal <constant>E_CORE_ERROR</constant>
        quando è abilitato.
       </entry>
      </row>
      <row>
       <entry>5.3.0</entry>
       <entry>
        Deprecato, e aggiunto l'errore <constant>E_DEPRECATED</constant>.
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </para>

  <sect1 xml:id="ini.sect.safe-mode">
   <title>Sicurezza e Safe Mode</title>
   <para>
    <table>
     <title>Direttive di configurazione della Modalità sicura e della Sicurezza</title>
     <tgroup cols="4">
      <thead>
       <row>
        <entry>&Name;</entry>
        <entry>&Default;</entry>
        <entry>&Changeable;</entry>
        <entry>&Changelog;</entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry><link linkend="ini.safe-mode">safe_mode</link></entry>
        <entry>"0"</entry>
        <entry>PHP_INI_SYSTEM</entry>
        <entry>Rimosso in PHP 5.4.0.</entry>
       </row>
       <row>
        <entry><link linkend="ini.safe-mode-gid">safe_mode_gid</link></entry>
        <entry>"0"</entry>
        <entry>PHP_INI_SYSTEM</entry>
        <entry> Rimosso in PHP 5.4.0.</entry>
       </row>
       <row>
        <entry><link linkend="ini.safe-mode-include-dir">safe_mode_include_dir</link></entry>
        <entry>NULL</entry>
        <entry>PHP_INI_SYSTEM</entry>
        <entry>Disponibile dal PHP 4.1.0. Rimosso in PHP 5.4.0.</entry>
       </row>
       <row>
        <entry><link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link></entry>
        <entry>""</entry>
        <entry>PHP_INI_SYSTEM</entry>
        <entry>Rimosso da PHP 5.4.0.</entry>
       </row>
       <row>
        <entry><link linkend="ini.safe-mode-allowed-env-vars">safe_mode_allowed_env_vars</link></entry>
        <entry>"PHP_"</entry>
        <entry>PHP_INI_SYSTEM</entry>
        <entry>Rimosso da PHP 5.4.0.</entry>
       </row>
       <row>
        <entry><link linkend="ini.safe-mode-protected-env-vars">safe_mode_protected_env_vars</link></entry>
        <entry>"LD_LIBRARY_PATH"</entry>
        <entry>PHP_INI_SYSTEM</entry>
        <entry>Rimosso da PHP 5.4.0.</entry>
       </row>
      </tbody>
     </tgroup>
    </table>
    &ini.php.constants;
   </para>
   
   &ini.descriptions.title;
   
   <para>
    <variablelist>
     <varlistentry xml:id="ini.safe-mode">
      <term>
       <parameter>safe_mode</parameter>
       <type>boolean</type>
      </term>
      <listitem>
       <para>
        Abilita o disabilita la modalità sicura di PHP. 
        Se PP è compilato con <literal>--enable-safe-mode</literal> è 
        On di default, altrimenti è Off.
       </para>
       &warn.deprecated.feature-5-3-0.removed-5-4-0;
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-gid">
      <term>
       <parameter>safe_mode_gid</parameter>
       <type>boolean</type>
      </term>
      <listitem>
       <para>
        Di default, Safe Mode fa un controllo dell'UID
        all'apertura dei file. Se si vuole ridurre questo controllo al GID,
        abilitare safe_mode_gid.
        Decide se controllare l'<literal>UID</literal> (&false;) o il
        <literal>GID</literal> (&true;) al momento dell'accesso
        ai file.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-include-dir">
      <term>
       <parameter>safe_mode_include_dir</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        I controlli <literal>UID</literal>/<literal>GID</literal> non vengono effettuati quando
        si includono i file da questa cartella o dalle sue sottocartelle (la cartella
        deve essere presente anche in <link linkend="ini.include-path">include_path</link>
        oppure occorre includere il percorso completo).
       </para>
       <simpara>
        Questa direttiva puà ricevere un percorso separato da due punti
        (o punto e virgola nei sistemi Windows) come nel caso del parametro
        <link linkend="ini.include-path">include_path</link>,
        piuttosto che solo una cartella.
       </simpara>
       <simpara>
        La restrizione specificata è un prefisso, non un nome di cartella. 
        Ciò significa che "<literal>safe_mode_include_dir = /dir/incl</literal>" permette
        l'accesso anche a "<literal>/dir/include</literal>" e 
        "<literal>/dir/incls</literal>" se esistono.  Quando si
        vuole restringere l'accesso solo alla cartella specificata, apporre uno
        slash. Per esempio: "safe_mode_include_dir = /dir/incl/"
       </simpara>
       <simpara>
        Se il valore di questo parametro è vuoto, nessun file con
        <literal>UID</literal>/<literal>GID</literal> differenti possono essere inclusi.
       </simpara>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-exec-dir">
      <term>
       <parameter>safe_mode_exec_dir</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        Se PHP è usato in modalità sicura, <function>system</function> e le altre
        <link linkend="ref.exec">funzioni che eseguono comandi di sistema</link>
        si rifiutano di eseguire programmi che non siano in questa cartella.
        Occore usare il simbolo <literal>/</literal> come separatore di cartelle in tutti gli
        ambientim incluso Windows.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-allowed-env-vars">
      <term>
       <parameter>safe_mode_allowed_env_vars</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        L'impostazione di alcune variabile d'ambiente può essere una potenziale violazione di sicurezza.
        Questo parametro contiene una lista di prefissi separati da virgole. In Safe Mode,
        l'utente può modificare solo quelle variabili d'ambiente il cui nome comincia con i
        prefissi indicati. Di default, gli utenti possono impostare solo
        le variabili d'ambiente che cominciano con <literal>PHP_</literal>
        (esempio <literal>PHP_FOO=BAR</literal>).
       </para>
       <note>
        <para>
         Se questo parametro è vuoto, PHP permettera all'utilizzatore di modificare QUALSIASI
         variabile d'ambiente!
        </para>
       </note>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-protected-env-vars">
      <term>
       <parameter>safe_mode_protected_env_vars</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        Questo parametro contiene una lista (separata da virgole) di variabili
        d'ambiente che l'utilizzatore finale non può cambiare usando
        <function>putenv</function>. Queste variabili saranno protette
        anche se safe_mode_allowed_env_vars permette la loro modifica.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </para>
   <para>
    Vedere anche: <link linkend="ini.open-basedir">open_basedir</link>,
    <link linkend="ini.disable-functions">disable_functions</link>,
    <link linkend="ini.disable-classes">disable_classes</link>,
    <link linkend="ini.register-globals">register_globals</link>,
    <link linkend="ini.display-errors">display_errors</link> e
    <link linkend="ini.log-errors">log_errors</link>.
   </para>

  <para>
   Quando <link linkend="ini.safe-mode">safe_mode</link> è attiva (on), il PHP
   verifica se il proprietario dello script in esecuzione e il proprietario del file su cui si sta operando con
   una funzione sui file coincidono. Per esempio:
   <programlisting role="ls">
<![CDATA[
-rw-rw-r--    1 rasmus   rasmus       33 Jul  1 19:20 script.php 
-rw-r--r--    1 root     root       1116 May 26 18:01 /etc/passwd 
]]>
   </programlisting>
   Eseguendo questo <filename>script.php</filename>:
   <programlisting role="php">
<![CDATA[
<?php
 readfile('/etc/passwd'); 
?>
]]>
   </programlisting>
   si ottiene questo errore quando Safe Mode è abilitata:
   <screen>
<![CDATA[
Warning: SAFE MODE Restriction in effect. The script whose uid is 500 is not 
allowed to access /etc/passwd owned by uid 0 in /docroot/script.php on line 2
]]>
   </screen>
  </para>
  <para>
   Comunque, possono esistere ambienti in cui un controllo rigido di <literal>UID</literal>
   è troppo restrittivo, e un controllo sul <literal>GID</literal> è
   sufficiente. Questo è supportato dal parametro <link
   linkend="ini.safe-mode-gid">safe_mode_gid</link>. Impostandolo a
   <literal>On</literal> si ottene il controllo su <literal>GID</literal>,
   impostandolo a <literal>Off</literal> si ha il controllo (di default)
   su <literal>UID</literal>.
  </para>
  <para>
   Se, invece di <link linkend="ini.safe-mode">safe_mode</link>, viene definita 
   una directory <link linkend="ini.open-basedir">open_basedir</link> allora tutte 
   le operazioni sui file saranno limitate ai file sottostanti la directory specificata.
   Per esempio (nel file httpd.conf di Apache):
   <programlisting role="ini">
<![CDATA[
<Directory /docroot>
  php_admin_value open_basedir /docroot 
</Directory>
]]>
   </programlisting>
   Se si esegue lo stesso <filename>script.php</filename> con questa
   impostazione di <link linkend="ini.open-basedir">open_basedir</link> 
   si ottiene come risultato: 
   <screen>
<![CDATA[
Warning: open_basedir restriction in effect. File is in wrong directory in 
/docroot/script.php on line 2 
]]>
   </screen>
  </para>
  <para>
   È possibile inoltre disabilitare le singole funzioni. Si note che il parametro
   <link linkend="ini.disable-functions">disable_functions</link>
   non può essere usato al di fuori di &php.ini;, il che significa che
   non si puossono disabilitare le funzioni in base al virtualhost o alla cartella
   nel file &httpd.conf;.
   Se si aggiunge la seguente riga al file php.ini:
   <programlisting role="ini">
<![CDATA[
disable_functions = readfile,system  
]]>
   </programlisting>
   si ottiene: 
   <screen>
<![CDATA[
Warning: readfile() has been disabled for security reasons in 
/docroot/script.php on line 2 
]]>
   </screen>
  </para>
  <warning>
   <para>
    Queste restrizioni di PHP non si applicano ovviamente sui file binari eseguiti.
   </para>
  </warning>
 </sect1>

  <sect1 xml:id="features.safe-mode.functions">
   <title>Funzioni limitate/disabilitate dalla modalità sicura (safe-mode)</title>
   <para>
    Questo è un elenco probabilmente ancora incompleto e forse non esatto delle
    funzioni limitate dalla
    <link linkend="features.safe-mode">modalità sicura</link>.
    <!-- TODO: add &note.sm.*; to the functions mentioned here.
    That entity should link to this section -->
    <table>
     <title>Funzioni limitate dalla modalità sicura</title>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>Funzioni</entry>
        <entry>Limitazioni</entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry><function>dbmopen</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>dbase_open</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro_rowcount</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro_retrieve</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry>ifx_*</entry>
        <entry>restrizioni sql_safe_mode, (!= safe mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry><function>ingres_*</function></entry>
        <entry>restrizioni sql_safe_mode, (!= safe mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry><function>mysql_*</function></entry>
        <entry>restrizioni sql_safe_mode, (!= safe mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry><function>pg_lo_import</function></entry>
        <entry>&sm.uidcheck;</entry>
        <!-- source TODO: there is no PHP-warning for that safe-mode-restriction -->
       </row>
       <row>
        <entry><function>posix_mkfifo</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>putenv</function></entry>
        <entry>Obbedisce le direttive del file ini safe_mode_protected_env_vars e 
        safe_mode_allowed_env_vars. Vedere la documentazione relativa
        on <function>putenv</function></entry>
        <!-- TODO: document those directives in chapters/config.xml -->
       </row>
       <row>
        <entry><function>move_uploaded_file</function></entry>
        <entry>&sm.uidcheck; <!-- TODO: check this --></entry>
       </row>

       <!-- TODO: from here on, add warning to the function itself -->

       <row>
        <entry><function>chdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>dl</function></entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><link linkend="language.operators.execution">operatore backtick</link></entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><function>shell_exec</function> (equivalente funzionale
        ai backtick)</entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><function>exec</function></entry>
        <entry>Si possono avviare solo i programmi all'interno di <link 
        linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Per ragioni pratiche non è al momento possibile utilizzare il 
        <literal>..</literal> nel percorso dell'eseguibile.
        <function>escapeshellcmd</function> viene eseguita sugli argomenti di questa
        funzione.</entry>
       </row>
       <row>
        <entry><function>system</function></entry>
        <entry>Si possono avviare solo i programmi all'interno di <link 
        linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Per ragioni pratiche non è al momento possibile utilizzare il 
        <literal>..</literal> nel percorso dell'eseguibile.
        <function>escapeshellcmd</function> viene eseguita sugli argomenti di questa
        funzione.</entry>
       </row>
       <row>
        <entry><function>passthru</function></entry>
        <entry>Si possono avviare solo i programmi all'interno di <link 
        linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Per ragioni pratiche non è al momento possibile utilizzare il 
        <literal>..</literal> nel percorso dell'eseguibile.
        <function>escapeshellcmd</function> viene eseguita sugli argomenti di questa
        funzione.</entry>
       </row>
       <row>
        <entry><function>popen</function></entry>
        <entry>Si possono avviare solo i programmi all'interno di <link 
        linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Per ragioni pratiche non è al momento possibile utilizzare il 
        <literal>..</literal> nel percorso dell'eseguibile.
        <function>escapeshellcmd</function> viene eseguita sugli argomenti di questa
        funzione.</entry>
        <!-- TODO: not sure. popen uses a completely different implementation
        Don't know why, don't know whether it's behaving the same -->
       </row>
       <row>
        <entry><function>fopen</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>mkdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>rmdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>rename</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;<!-- on the old name only, it seems. Is rename preventing moving files? --></entry>
       </row>
       <row>
        <entry><function>unlink</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>copy</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; (on 
        <parameter>source</parameter> and 
        <parameter>target</parameter>)</entry>
       </row>
       <row>
        <entry><function>chgrp</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>chown</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>chmod</function></entry>
        <entry>&sm.uidcheck; Inoltre, non si possono
        impostare SUID, SGID e sticky bits</entry>
       </row>
       <row>
        <entry><function>touch</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>symlink</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; (nota: solo il file di destinazione è 
        verificato)</entry>
       </row>
       <row>
        <entry><function>link</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; (nota: solo il file di destinazione è 
        verificato)</entry>
       </row>
       <row>
        <entry><function>apache_request_headers</function></entry>
        <entry>In safe mode, gli header che cominciano con <literal>authorization</literal> 
        (case-insensitive) non saranno restituiti.</entry>
       </row>
       <row>
        <entry><function>header</function></entry>
        <entry>Quando si è in modalità sicura, l'uid dello script viene aggiunto al
        <literal>realm</literal> dell'header
        <literal>WWW-Authenticate</literal> nel caso questo header venga
        impostato (usato per l'autenticazione HTTP).</entry>
       </row>
       <row>
        <entry><link linkend="features.http-auth">varabili PHP_AUTH</link></entry>
        <entry>
         In modalità sicura, le variabili <varname>PHP_AUTH_USER</varname>,
         <varname>PHP_AUTH_PW</varname> e <varname>AUTH_TYPE</varname>
         non sono disponibili in <varname>$_SERVER</varname>. Si può comunque
         usare <varname>REMOTE_USER</varname> per conoscere l'utilizzatore.
         (nota: solo dal PHP 4.3.0)
        </entry>
       </row>
       <row>
        <entry>
         <function>highlight_file</function>,
         <function>show_source</function>
        </entry>
        <entry>
         &sm.uidcheck; &sm.uidcheck.dir;
        </entry>
       </row>
       <row>
        <entry>
         <function>parse_ini_file</function>
        </entry>
        <entry>
         &sm.uidcheck; &sm.uidcheck.dir;
        </entry>
       </row>
       <row>
        <entry>
         <function>set_time_limit</function>
        </entry>
        <entry>
         Non ha effetto quando PHP è eseguito in &safemode;.
        </entry>
       </row>
       <row>
        <entry>
         <link linkend="ini.max-execution-time">max_execution_time</link>
        </entry>
        <entry>
         Non ha effetto quando PHP è eseguito in &safemode;.
        </entry>
       </row>
       <row>
        <entry>
         <function>mail</function>
        </entry>
        <entry>
         In safe mode, il quinto parametro è disabilitato.
        </entry>
       </row>
       <row>
        <entry>
         <function>session_start</function>
        </entry>
        <entry>
         Il proprietario dello script deve esserlo anche della cartella <link
         linkend="ini.session.save-path">session.save_path</link> se 
         viene usato il <link 
         linkend="ini.session.save-handler">session.save_handler</link> di
         default, <literal>files</literal>.
        </entry>
       </row>
       <row>
        <entry>
         tutte le funzioni di filesystem e stream.
        </entry>
        <entry>
         &sm.uidcheck; &sm.uidcheck.dir; (vedere l'opzione <link
          linkend="ini.safe-mode-include-dir">safe_mode_include_dir</link>
         in &php.ini;.
        </entry>
       </row>
      </tbody>
     </tgroup>
    </table>
   </para>
  </sect1>

 </chapter>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
